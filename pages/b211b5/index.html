<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>深入了解ByteBuf | Kangec blog</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="浅墨漫芳华 热爱生活，分享技术">
    <meta name="keywords" content="个人技术博客,后端,后端开发,后端框架,Spring,Spring面试题,技术文档,学习,面试,Java,js,ES6,vue,,Node,git,github,markdown">
    <meta name="theme-color" content="#11a8cd">
    <link rel="preload" href="/assets/css/0.styles.a53acfa3.css" as="style"><link rel="preload" href="/assets/js/app.a6c26de7.js" as="script"><link rel="preload" href="/assets/js/3.f705ad0c.js" as="script"><link rel="preload" href="/assets/js/43.03e23912.js" as="script"><link rel="prefetch" href="/assets/js/10.c8cdf6e4.js"><link rel="prefetch" href="/assets/js/11.9afcabb3.js"><link rel="prefetch" href="/assets/js/12.df69db59.js"><link rel="prefetch" href="/assets/js/13.61fcc519.js"><link rel="prefetch" href="/assets/js/14.423ce86d.js"><link rel="prefetch" href="/assets/js/15.bff6355a.js"><link rel="prefetch" href="/assets/js/16.6a96c620.js"><link rel="prefetch" href="/assets/js/17.b65bf8f4.js"><link rel="prefetch" href="/assets/js/18.dbee088c.js"><link rel="prefetch" href="/assets/js/19.2303b154.js"><link rel="prefetch" href="/assets/js/20.7fc05395.js"><link rel="prefetch" href="/assets/js/21.e4d3520c.js"><link rel="prefetch" href="/assets/js/22.c21c798d.js"><link rel="prefetch" href="/assets/js/23.c89bbfaa.js"><link rel="prefetch" href="/assets/js/24.d6cda47c.js"><link rel="prefetch" href="/assets/js/25.f21c82b9.js"><link rel="prefetch" href="/assets/js/26.9b0f7646.js"><link rel="prefetch" href="/assets/js/27.65effe37.js"><link rel="prefetch" href="/assets/js/28.cf5448bf.js"><link rel="prefetch" href="/assets/js/29.467ce371.js"><link rel="prefetch" href="/assets/js/30.cc5dbcf2.js"><link rel="prefetch" href="/assets/js/31.25b02f2d.js"><link rel="prefetch" href="/assets/js/32.ef073d43.js"><link rel="prefetch" href="/assets/js/33.ccf3c739.js"><link rel="prefetch" href="/assets/js/34.3fc7e29f.js"><link rel="prefetch" href="/assets/js/35.84c8354a.js"><link rel="prefetch" href="/assets/js/36.797884b0.js"><link rel="prefetch" href="/assets/js/37.84f05ecd.js"><link rel="prefetch" href="/assets/js/38.9d3b2ba7.js"><link rel="prefetch" href="/assets/js/39.5db5a1fb.js"><link rel="prefetch" href="/assets/js/4.cd903b0e.js"><link rel="prefetch" href="/assets/js/40.8ea0563b.js"><link rel="prefetch" href="/assets/js/41.d56a7fa5.js"><link rel="prefetch" href="/assets/js/42.3a1bf407.js"><link rel="prefetch" href="/assets/js/44.614ab454.js"><link rel="prefetch" href="/assets/js/45.61bbcde8.js"><link rel="prefetch" href="/assets/js/46.c73f4262.js"><link rel="prefetch" href="/assets/js/47.cba5f1ab.js"><link rel="prefetch" href="/assets/js/48.e9b2c3ba.js"><link rel="prefetch" href="/assets/js/49.f980363a.js"><link rel="prefetch" href="/assets/js/5.8a3e764f.js"><link rel="prefetch" href="/assets/js/50.c82ccbff.js"><link rel="prefetch" href="/assets/js/51.1002c86c.js"><link rel="prefetch" href="/assets/js/52.ea1ea199.js"><link rel="prefetch" href="/assets/js/53.ec91ae3c.js"><link rel="prefetch" href="/assets/js/54.4f1e9930.js"><link rel="prefetch" href="/assets/js/55.13746af7.js"><link rel="prefetch" href="/assets/js/56.83a7a426.js"><link rel="prefetch" href="/assets/js/57.04f19ef3.js"><link rel="prefetch" href="/assets/js/58.08578726.js"><link rel="prefetch" href="/assets/js/59.5edc449d.js"><link rel="prefetch" href="/assets/js/6.6afffd69.js"><link rel="prefetch" href="/assets/js/60.05c37c38.js"><link rel="prefetch" href="/assets/js/61.77ebeafb.js"><link rel="prefetch" href="/assets/js/62.072908db.js"><link rel="prefetch" href="/assets/js/63.6a587934.js"><link rel="prefetch" href="/assets/js/64.7480f922.js"><link rel="prefetch" href="/assets/js/65.dc7e2c6b.js"><link rel="prefetch" href="/assets/js/66.05d82fec.js"><link rel="prefetch" href="/assets/js/67.30b018bf.js"><link rel="prefetch" href="/assets/js/68.3a1140cd.js"><link rel="prefetch" href="/assets/js/69.8511063d.js"><link rel="prefetch" href="/assets/js/7.28551235.js"><link rel="prefetch" href="/assets/js/70.df39132b.js"><link rel="prefetch" href="/assets/js/71.fc3a8975.js"><link rel="prefetch" href="/assets/js/72.b9d516e9.js"><link rel="prefetch" href="/assets/js/73.dafd88fa.js"><link rel="prefetch" href="/assets/js/74.7d937f6a.js"><link rel="prefetch" href="/assets/js/8.764e8ee7.js"><link rel="prefetch" href="/assets/js/9.c0d73f82.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.04b62663.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a53acfa3.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="Kangec blog" class="logo"> <span class="site-name can-hide">Kangec blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/categories/" class="nav-link">分类</a></div><div class="nav-item"><a href="/food/" class="nav-link">美食</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专栏" class="dropdown-title"><a href="/column/" class="link-title">专栏</a> <span class="title" style="display:none;">专栏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/66f7b1/" class="nav-link"> Java基础</a></li><li class="dropdown-item"><!----> <a href="/pages/943ab2/" class="nav-link"> Netty</a></li><li class="dropdown-item"><!----> <a href="/pages/958a5b/" class="nav-link"> Spring</a></li><li class="dropdown-item"><!----> <a href="/pages/a7e17e/" class="nav-link"> Mybatis</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/kangec/kangec.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/logo.png"> <div class="blogger-info"><h3>Kangec liu</h3> <span>
        浅墨漫芳华
      </span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/categories/" class="nav-link">分类</a></div><div class="nav-item"><a href="/food/" class="nav-link">美食</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专栏" class="dropdown-title"><a href="/column/" class="link-title">专栏</a> <span class="title" style="display:none;">专栏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/66f7b1/" class="nav-link"> Java基础</a></li><li class="dropdown-item"><!----> <a href="/pages/943ab2/" class="nav-link"> Netty</a></li><li class="dropdown-item"><!----> <a href="/pages/958a5b/" class="nav-link"> Spring</a></li><li class="dropdown-item"><!----> <a href="/pages/a7e17e/" class="nav-link"> Mybatis</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/kangec/kangec.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Netty专栏</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/943ab2/" class="sidebar-link">Netty简介</a></li><li><a href="/pages/de07fb/" class="sidebar-link">传统BIO编程</a></li><li><a href="/pages/672c6e/" class="sidebar-link">NIO编程</a></li><li><a href="/pages/d7e307/" class="sidebar-link">NIO非阻塞网络编程原理分析</a></li><li><a href="/pages/1552f3/" class="sidebar-link">Netty线程模型</a></li><li><a href="/pages/17a672/" class="sidebar-link">Netty编解码机制</a></li><li><a href="/pages/e107d9/" class="sidebar-link">Netty解决TCP拆包粘包</a></li><li><a href="/pages/b211b5/" aria-current="page" class="active sidebar-link">深入了解ByteBuf</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/b211b5/#bytebuf功能介绍" class="sidebar-link">ByteBuf功能介绍</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/b211b5/#_1-1-工作原理" class="sidebar-link">1.1 工作原理</a></li><li class="sidebar-sub-header"><a href="/pages/b211b5/#_1-2-bytebuf动态扩展" class="sidebar-link">1.2 ByteBuf动态扩展</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/b211b5/#bytebuf源码分析" class="sidebar-link">ByteBuf源码分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/b211b5/#_2-1-bytebuf主要继承关系" class="sidebar-link">2.1 ByteBuf主要继承关系</a></li><li class="sidebar-sub-header"><a href="/pages/b211b5/#_2-2-abstractbytebuf" class="sidebar-link">2.2 AbstractByteBuf</a></li><li class="sidebar-sub-header"><a href="/pages/b211b5/#_2-3-abstractreferencecountedbytebuf" class="sidebar-link">2.3 AbstractReferenceCountedByteBuf</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Spring专栏</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MyBatis专栏</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Reactor</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"> <div class="theme-vdoing-wrapper"><div class="articleInfo-wrap" data-v-14888ed5><div class="articleInfo" data-v-14888ed5><ul class="breadcrumbs" data-v-14888ed5><li data-v-14888ed5><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-14888ed5></a></li> <li data-v-14888ed5><a href="/column" title="专栏-目录页" data-v-14888ed5>专栏</a></li> <li data-v-14888ed5><a href="/column/#Netty专栏" title="专栏#Netty专栏" data-v-14888ed5>Netty专栏</a></li></ul> <div class="info" data-v-14888ed5><div title="作者" class="author iconfont icon-touxiang" data-v-14888ed5><a href="https://github.com/kangec" target="_blank" title="作者" class="beLink" data-v-14888ed5>Kangec liu</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-14888ed5><a href="javascript:;" data-v-14888ed5>2020-09-20</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">
          深入了解ByteBuf
        </h1> <div class="theme-vdoing-content content__default"><h2 id="bytebuf功能介绍"><a href="#bytebuf功能介绍" class="header-anchor">#</a> ByteBuf功能介绍</h2> <p>从功能角度而言，ByteBuffer完全可以满足NIO编程的需要，但是由于NIO编程的复杂性， ByteBuffer也有其局限性，它的主要缺点如下。</p> <ol><li>ByteBuffer长度固定，一旦分配完成，它的容量不能动态扩展和收缩，当需要编码的POJO对象大于ByteBuffer的容量时，会发生索引越界异常;</li> <li>ByteBuffer只有一个标识位置的指针 position，读写的时候需要手工调用flip()和rewind()等，使用者必须小心谨慎地处理这些API，否则很容易导致程序处理失败</li> <li>ByteBuffer的API功能有限，一些高级和实用的特性它不支持，需要使用者自己
编程实现</li></ol> <p>为了弥补这些不足，Nety提供了自己的 ByteBuffer 实现-ByteBuf。</p> <h3 id="_1-1-工作原理"><a href="#_1-1-工作原理" class="header-anchor">#</a> 1.1 工作原理</h3> <p>ByteBuf通过两个位置指针来协助缓冲区的读写操作，读操作使用 readerIndex，写操作使用 writerIndex。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code> *      +-------------------+------------------+------------------+
 *      | discardable bytes |  readable bytes  |  writable bytes  |
 *      |                   |     (CONTENT)    |                  |
 *      +-------------------+------------------+------------------+
 *      |                   |                  |                  |
 *      0      &lt;=      readerIndex   &lt;=   writerIndex    &lt;=    capacity
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>readerIndex和 writerIndex的取值一开始都是<strong>0</strong>,随着数据的写入 writerIndex 会增加，读取数据会使 readerlndex 增加，但是它不会超过 writerlndex。</p> <p>在读取之后，**(0 ~ readerlndex)**就被视为 discard 的，调用 discarDreadBytes 方法，可以释放这部分空间，它的作用类似ByteBuffer的compact方法。 **(readerIndex ~ writerIndex)**之间的数据是可读取的，等价于ByteBuffer position 和 limit 之间的数据。 **(writerIndex ~ capacity)**之间的空间是可写的，等价于 ByteBuffer limit和 capacity之间的可用空间。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>*  BEFORE discardReadBytes()
*
*      +-------------------+------------------+------------------+
*      | discardable bytes |  readable bytes  |  writable bytes  |
*      +-------------------+------------------+------------------+
*      |                   |                  |                  |
*      0      &lt;=      readerIndex   &lt;=   writerIndex    &lt;=    capacity
*
*
*  AFTER discardReadBytes()
*
*      +------------------+--------------------------------------+
*      |  readable bytes  |    writable bytes (got more space)   |
*      +------------------+--------------------------------------+
*      |                  |                                      |
* readerIndex (0) &lt;= writerIndex (decreased)        &lt;=        capacity
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>由于写操作不修改 readerIndex指针，读操作不修改 writerIndex指针，因此读写之间不再需要调整位置指针，这极大地简化了缓冲区的读写操作，避免了由于遗漏或者不熟悉flip()操作导致的功能异常。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>*  BEFORE clear()
*
*      +-------------------+------------------+------------------+
*      | discardable bytes |  readable bytes  |  writable bytes  |
*      +-------------------+------------------+------------------+
*      |                   |                  |                  |
*      0      &lt;=      readerIndex   &lt;=   writerIndex    &lt;=    capacity
*
*  AFTER clear()
*
*      +---------------------------------------------------------+
*      |             writable bytes (got more space)             |
*      +---------------------------------------------------------+
*      |                                                         |
*      0 = readerIndex = writerIndex            &lt;=            capacity
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="_1-2-bytebuf动态扩展"><a href="#_1-2-bytebuf动态扩展" class="header-anchor">#</a> 1.2 ByteBuf动态扩展</h3> <p>通常情况下，对 ByteBuffer 进行put操作时，如果缓冲区剩余可写空间不够，就会发生 BufferOverflowException。为了避免发生这个问题，通常在进行put操作的时候会对剩余可用空间进行校验。如果剩余空间不足，需要重新创建一个新的 ByteBuffer，并将之前的 ByteBuffer 复制到新创建的 ByteBuffer中，最后释放老的 ByteBuffer。对此，为了防止 ByteBuffer 溢出，都会对可用空间进行校验，导致了代码冗余，而且可能引入其他问题。</p> <p>为了解决这个问题，ByteBuf 对 write 操作进行了封装，由 ByteBuf 的 write 操作负责进行剩余可用空间的校验，如果可用缓冲区不足，ByteBuf会自动进行动态扩展，对于使用者而言，不需要关心底层的校验和扩展细节，只要不超过设置的最大缓冲区容量即可。当可用空间不足时，
ByteBuf会帮助我们实现自动扩展，这极大地降低了 ByteBuf 的学习和使用成本，提升了开发效率。校验和扩展的相关代码：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ByteBuf</span> <span class="token function">writeByte</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ensureWritable0</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">_setByte</span><span class="token punctuation">(</span>writerIndex<span class="token operator">++</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>当进行 write 操作时会对需要 write 的字节进行校验，如果可写的字节数小于需要写入的字节数，并且需要写入的字节数小于可写的最大字节数时，对缓冲区进行动态扩展。</p> <p>由于NIO的Channel读写的参数都是 ByteBuffer 因此，Nety的 ByteBuf 接口必须提供API方便的将 Bytebuf 转换成 ByteBuffer，或者将 ByteBuffer包装成 ByteBuf。考虑到性能，应该尽量避免缓冲区的复制，内部实现的时候可以考虑聚合一个 ByteBuffer 的私有指针用来代表 ByteBuffer.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">ensureWritable0</span><span class="token punctuation">(</span><span class="token keyword">int</span> minWritableBytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ensureAccessible</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>minWritableBytes <span class="token operator">&lt;=</span> <span class="token function">writableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> writerIndex <span class="token operator">=</span> <span class="token function">writerIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>checkBounds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>minWritableBytes <span class="token operator">&gt;</span> maxCapacity <span class="token operator">-</span> writerIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IndexOutOfBoundsException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;writerIndex(%d) + minWritableBytes(%d) exceeds maxCapacity(%d): %s&quot;</span><span class="token punctuation">,</span>
                    writerIndex<span class="token punctuation">,</span> minWritableBytes<span class="token punctuation">,</span> maxCapacity<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Normalize the current capacity to the power of 2.</span>
    <span class="token keyword">int</span> minNewCapacity <span class="token operator">=</span> writerIndex <span class="token operator">+</span> minWritableBytes<span class="token punctuation">;</span>
    <span class="token keyword">int</span> newCapacity <span class="token operator">=</span> <span class="token function">alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">calculateNewCapacity</span><span class="token punctuation">(</span>minNewCapacity<span class="token punctuation">,</span> maxCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> fastCapacity <span class="token operator">=</span> writerIndex <span class="token operator">+</span> <span class="token function">maxFastWritableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Grow by a smaller amount if it will avoid reallocation</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newCapacity <span class="token operator">&gt;</span> fastCapacity <span class="token operator">&amp;&amp;</span> minNewCapacity <span class="token operator">&lt;=</span> fastCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newCapacity <span class="token operator">=</span> fastCapacity<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Adjust to the new capacity.</span>
    <span class="token function">capacity</span><span class="token punctuation">(</span>newCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">ensureAccessible</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>checkAccessible <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isAccessible</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalReferenceCountException</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h2 id="bytebuf源码分析"><a href="#bytebuf源码分析" class="header-anchor">#</a> ByteBuf源码分析</h2> <h3 id="_2-1-bytebuf主要继承关系"><a href="#_2-1-bytebuf主要继承关系" class="header-anchor">#</a> 2.1 ByteBuf主要继承关系</h3> <p><img alt="" data-src="https://i.loli.net/2020/09/20/Mf7kNOeURwTzt1x.png" loading="lazy" class="lazy"></p> <p>从内存分配的角度看， ByteBuf可以分为两类：</p> <ol><li>堆内存（ HeapByteBuf）字节缓冲区：特点是内存的分配和回收速度快，可以被JVM自动回收；缺点就是如果进行 Socket的IO读写，需要额外做一次内存复制，将堆内存对应的缓冲区复制到内核 Channel中，性能会有一定程度的下降。</li> <li>直接内存（ DirectByteBuf）字节缓冲区：非堆内存，它在堆外进行内存分配，相比于堆内存，它的分配和回收速度会慢一些，但是将它写入或者从 Socket Channel中读取时，由于少了一次内存复制，速度比堆内存快。</li></ol> <p>正是因为各有利弊，所以Nety提供了多种 ByteBuf供开发者使用，经验表明， ByteBuf的最佳实践是<strong>在IO通信线程的读写缓冲区使用 DirectByteBuf</strong>，<strong>后端业务消息的编解码模块使用 HeapByteBuf。这样组合可以达到性能最优</strong>。</p> <p>从内存回收角度看， ByteBuf也分为两类：基于对象池的 ByteBuf和普通 ByteBuf。两者的主要区别就是<strong>基于对象池的 ByteBuf 可以重用 ByteBuf 对象</strong>，它自己维护了一个内存池，可以循环利用创建的 ByteBuf，提升内存的使用效率，降低由于高负载导致的频繁GC测试表明使用内存池后的Nety在高负载、大并发的冲击下内存和GC更加平稳。</p> <p>尽管推荐使用基于内存池的 ByteBuf，但是内存池的管理和维护更加复杂，使用起来也需要更加谨慎。因此，Nety提供了灵活的策略供使用者来做选择。</p> <h3 id="_2-2-abstractbytebuf"><a href="#_2-2-abstractbytebuf" class="header-anchor">#</a> 2.2 AbstractByteBuf</h3> <h4 id="成员变量"><a href="#成员变量" class="header-anchor">#</a> 成员变量</h4> <p>首先，像读索引、写索引、mark、最大容量等公共属性需要定义。我们重点关注下 leakDetector，它被定义为 static，意味着所有的 ByteBuf实例共享同个 ResourceLeakDetector对象。 ResourceLeakDetector用于检测对象是否泄漏。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ResourceLeakDetector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ByteBuf</span><span class="token punctuation">&gt;</span></span> leakDetector <span class="token operator">=</span>
        <span class="token class-name">ResourceLeakDetectorFactory</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newResourceLeakDetector</span><span class="token punctuation">(</span><span class="token class-name">ByteBuf</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> readerIndex<span class="token punctuation">;</span>
<span class="token keyword">int</span> writerIndex<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> markedReaderIndex<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> markedWriterIndex<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> maxCapacity<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>在 AbstractByteBuf中并<strong>没有定义 ByteBuf的缓冲区实现</strong>，例如byte数组或者 DirectByteBuffer。原因显而易见，因为 AbstractByteBuf并不清楚子类到底是基于堆内存还是直接内存，因此无法提前定义。</p> <h4 id="读操作"><a href="#读操作" class="header-anchor">#</a> 读操作</h4> <p>无论子类如何实现ByteBuf，它们最终都是操作ByteBuffer，功能相同且操作结果等价。ByteBuf提供了多种类型的read操作，将以<code>readBytes(byte[] dst, int dstIndex, int length)</code>为例，其他操作类似，不做过多的介绍。源代码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ByteBuf</span> <span class="token function">readBytes</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dst<span class="token punctuation">,</span> <span class="token keyword">int</span> dstIndex<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">checkReadableBytes</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 1</span>
    <span class="token function">getBytes</span><span class="token punctuation">(</span>readerIndex<span class="token punctuation">,</span> dst<span class="token punctuation">,</span> dstIndex<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
    readerIndex <span class="token operator">+=</span> length<span class="token punctuation">;</span> <span class="token comment">// 3</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol><li><strong>校验缓冲区可用空间</strong>。如果读取的长度小于0,则抛出 IllegalArgumentException 异常提示参数非法：如果可写的字节数小于需要读取的长度，则抛出 IndexOutOfBoundsException 异常。</li> <li><strong>调用getBytes，从当前的读索引开始，复制 length个字节到目标byte数组中</strong>。由于不同的子类复制操作的技术实现细节不同，因此该方法由子类实现。</li> <li><strong>对读索引递增</strong>。</li></ol> <h4 id="写操作"><a href="#写操作" class="header-anchor">#</a> 写操作</h4> <p>与读操作类似，将以<code>writeBytes(byte[] src, int srcIndex, int length)</code>为例，源码如下。它的功能是<strong>将源数组的srcIndex开始，srcIndex+length 截至的源数组写入到当前ByteBuf</strong>。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ByteBuf</span> <span class="token function">writeBytes</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> src<span class="token punctuation">,</span> <span class="token keyword">int</span> srcIndex<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ensureWritable</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
    <span class="token function">setBytes</span><span class="token punctuation">(</span>writerIndex<span class="token punctuation">,</span> src<span class="token punctuation">,</span> srcIndex<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2 </span>
    writerIndex <span class="token operator">+=</span> length<span class="token punctuation">;</span>  <span class="token comment">// 3</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol><li><strong>校验写入数组长度</strong>。如果写入的数组长度小于0,则抛出 IllegalArgumentException 异常提示参数非法：如果写入的数组字节数小于当前可写的长度则说明可写入，直接返回。如果写入的字节数组长度大于可以动态扩展的最大可写字节数，说明缓冲区无法写入超过其最大容量的字节数组，抛出 IndexOutOfBoundsException 异常。</li> <li><strong>调用setBytes将源数组的srcIndex开始，srcIndex+length 截至的源数组写入到当前ByteBuf</strong>。由于不同的子类复制操作的技术实现细节不同，因此该方法由子类实现。</li> <li><strong>对写索引递增</strong>。</li></ol> <p>Netty的 ByteBuffer可以动态扩展，为了保证安全性，允许使用者指定最大的容量。在容量范围内，可以先分配个较小的初始容量，后面不够用再动态扩展，这样可以达到功能和性能的最优组合。</p> <p>calculateNewCapacity 方法的实现：首先需要重新计算下扩展后的容量，它有一个参数，等于 writerIndex+ minWritableBytes，也就是满足要求的最小容量。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">calculateNewCapacity</span><span class="token punctuation">(</span><span class="token keyword">int</span> minNewCapacity<span class="token punctuation">,</span> <span class="token keyword">int</span> maxCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">checkPositiveOrZero</span><span class="token punctuation">(</span>minNewCapacity<span class="token punctuation">,</span> <span class="token string">&quot;minNewCapacity&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>minNewCapacity <span class="token operator">&gt;</span> maxCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>
                <span class="token string">&quot;minNewCapacity: %d (expected: not greater than maxCapacity(%d)&quot;</span><span class="token punctuation">,</span>
                minNewCapacity<span class="token punctuation">,</span> maxCapacity<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">final</span> <span class="token keyword">int</span> threshold <span class="token operator">=</span> CALCULATE_THRESHOLD<span class="token punctuation">;</span> <span class="token comment">// 4 MiB page  </span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>minNewCapacity <span class="token operator">==</span> threshold<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> threshold<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// If over threshold, do not double but just increase by threshold.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>minNewCapacity <span class="token operator">&gt;</span> threshold<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> newCapacity <span class="token operator">=</span> minNewCapacity <span class="token operator">/</span> threshold <span class="token operator">*</span> threshold<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newCapacity <span class="token operator">&gt;</span> maxCapacity <span class="token operator">-</span> threshold<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            newCapacity <span class="token operator">=</span> maxCapacity<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            newCapacity <span class="token operator">+=</span> threshold<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> newCapacity<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Not over threshold. Double up to 4 MiB, starting from 64.</span>
    <span class="token keyword">int</span> newCapacity <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>newCapacity <span class="token operator">&lt;</span> minNewCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newCapacity <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>newCapacity<span class="token punctuation">,</span> maxCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>首先设置<strong>门限阈值为4M</strong>，当需要的新容量正好等于门限阈值，则使用阈值作为新的缓冲区容量。如果新申请的内存空间大于阈值，不能采用倍增的方式（防止内存膨胀和浪费）扩张内存，采用<strong>每次步进4M的方式进行内存扩张</strong>。扩张的时候需要对扩张后的内存和最大内存（ maxCapacity）进行比较，如果大于缓冲区的最大长度，则使用 maxCapacity 作为扩容后的缓冲区容量。<strong>如果扩容后的新容量小于阈值，则以64为计数进行倍增，直到倍增后的结果大于或等于需要的容量值</strong>。</p> <p>重新计算完动态扩张后的目标容量后，需要重新创建个新的缓冲区，将原缓冲区的内容复制到新创建的 ByteBuf中，最后设置读写索引和mark标签等。由于不同的子类会对应不同的复制操作，所以该方法依然是个抽象方法，由子类负责实现。</p> <h3 id="_2-3-abstractreferencecountedbytebuf"><a href="#_2-3-abstractreferencecountedbytebuf" class="header-anchor">#</a> 2.3 AbstractReferenceCountedByteBuf</h3> <p>该类主要是<strong>对引用进行计数</strong>，类似于JM内存回收的对象引用计数器，用于跟踪对象的分配和销毁，做自动内存回收。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> REFCNT_FIELD_OFFSET <span class="token operator">=</span>
        <span class="token class-name">ReferenceCountUpdater</span><span class="token punctuation">.</span><span class="token function">getUnsafeOffset</span><span class="token punctuation">(</span><span class="token class-name">AbstractReferenceCountedByteBuf</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;refCnt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AtomicIntegerFieldUpdater</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractReferenceCountedByteBuf</span><span class="token punctuation">&gt;</span></span> AIF_UPDATER <span class="token operator">=</span>
        <span class="token class-name">AtomicIntegerFieldUpdater</span><span class="token punctuation">.</span><span class="token function">newUpdater</span><span class="token punctuation">(</span><span class="token class-name">AbstractReferenceCountedByteBuf</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;refCnt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ReferenceCountUpdater</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractReferenceCountedByteBuf</span><span class="token punctuation">&gt;</span></span> updater <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">ReferenceCountUpdater</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractReferenceCountedByteBuf</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">AtomicIntegerFieldUpdater</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractReferenceCountedByteBuf</span><span class="token punctuation">&gt;</span></span> <span class="token function">updater</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> AIF_UPDATER<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">long</span> <span class="token function">unsafeOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> REFCNT_FIELD_OFFSET<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Value might not equal &quot;real&quot; reference count, all access should be via the updater</span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unused&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> refCnt <span class="token operator">=</span> updater<span class="token punctuation">.</span><span class="token function">initialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><ol><li>REFCNT_FIELD_OFFSET：它用于<strong>标识 refCnt字段在 AbstractReferenceCountedByteBuf 中的内存地址</strong>，该内存地址的获取是JDK实现强相关的，如果使用SUN的JDK，它通过 <code>sun.misc.Unsafe</code>的 <code>PlatformDependent.objectFieldOffset</code>接口来获得， ByteBuf的实现子类 <strong>UnpooledUnsafeDirectByteBuf</strong>和<strong>PooledUnsafeDirectByteBuf</strong>会使用到这个偏移量。</li> <li>AIF_UPDATER：它是AtomicIntegerFieldUpdater类型变量，通过原子的方式对成员变量进行更新等操作，以实现线程安全，消除锁。</li> <li>最后定义了一个 volatile 修饰的 refCnt 字段用于<strong>跟踪对象的引用次数</strong>，使用 volatile 是为了解决多线程并发访问的可见性问题。</li></ol></div></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/kangec/kangec.github.io/edit/master/docs/02.专栏/02.Netty专栏/15.深入了解ByteBuf.md" target="_blank" rel="noopener noreferrer">编辑</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="tags"><a href="/tags/?tag=Netty" title="标签">
      #Netty
    </a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2020/09/20, 7:09:00</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/e107d9/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">
        Netty解决TCP拆包粘包
      </div></a> <a href="/pages/958a5b/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">
        spring如何解决循环依赖
      </div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/e107d9/" class="prev">Netty解决TCP拆包粘包</a></span> <span class="next"><a href="/pages/958a5b/">spring如何解决循环依赖</a>
        →
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/d362b2/"><div>多线程交替打印</div></a> <span>10-13</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/598bf0/"><div>微车管云上部署</div></a> <span>10-12</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/005440/"><div>MySQL分页查询</div></a> <span>10-11</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div> </main></div> <div class="footer"><div class="icons"><a href="mailto:ardien@126.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/kangec" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="http://music.163.com/playlist?id=630677470" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
     | Copyright © 2021-2020
    <span>Kangec | MIT License</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url(https://i.loli.net/2020/09/02/H24vouiMnG81N9l.jpg) center center / cover no-repeat;"></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.a6c26de7.js" defer></script><script src="/assets/js/3.f705ad0c.js" defer></script><script src="/assets/js/43.03e23912.js" defer></script>
  </body>
</html>